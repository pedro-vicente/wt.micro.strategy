#ifndef METRICS_HH
#define METRICS_HH

#include <string>
#include <vector>
#include <cmath>

/////////////////////////////////////////////////////////////////////////////////////////////////////
// FinancialRecord
/////////////////////////////////////////////////////////////////////////////////////////////////////

struct FinancialRecord
{
  std::string period;
  std::string company_id;
  double revenue;
  double cogs;
  double operating_expenses;
  double depreciation;
  double amortization;
  double interest;
  double taxes;
  double current_assets;
  double current_liabilities;
  double inventory;
  double total_assets;
  double total_liabilities;
};

/////////////////////////////////////////////////////////////////////////////////////////////////////
// FinancialMetrics
/////////////////////////////////////////////////////////////////////////////////////////////////////

struct FinancialMetrics
{
  std::string period;
  std::string company_id;

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  // input values
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  double revenue;
  double cogs;
  double operating_expenses;
  double depreciation;
  double amortization;
  double interest;
  double taxes;
  double current_assets;
  double current_liabilities;
  double inventory;
  double total_assets;
  double total_liabilities;

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  // profitability metrics
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  double gross_profit() const;
  double gross_margin() const;
  double ebitda() const;
  double ebit() const;
  double net_income() const;
  double net_margin() const;
  double operating_margin() const;

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  // liquidity metrics
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  double working_capital() const;
  double current_ratio() const;
  double quick_ratio() const;

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  // leverage metrics
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  double equity() const;
  double debt_to_equity() const;
  double debt_ratio() const;

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  // return metrics
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  double return_on_assets() const;
  double return_on_equity() const;
};

/////////////////////////////////////////////////////////////////////////////////////////////////////
// MovingAverage
// SMA and EMA calculator
/////////////////////////////////////////////////////////////////////////////////////////////////////

class MovingAverage
{
public:
  MovingAverage(size_t period) : period(period) {}

  void add(double value) { values.push_back(value); }
  void clear() { values.clear(); }
  size_t size() const { return values.size(); }

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  // sma
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  double sma(size_t idx) const
  {
    if (idx >= values.size() || idx < period - 1) return 0.0;
    double sum = 0.0;
    for (size_t jdx = idx - period + 1; jdx <= idx; ++jdx)
    {
      sum += values[jdx];
    }
    return sum / period;
  }

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  // ema
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  double ema(size_t idx) const
  {
    if (idx >= values.size()) return 0.0;
    if (idx == 0) return values[0];
    double k = 2.0 / (period + 1);
    double prev = (idx < period) ? sma(idx - 1) : ema(idx - 1);
    return values[idx] * k + prev * (1 - k);
  }

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  // all_sma
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  std::vector<double> all_sma() const
  {
    std::vector<double> result;
    for (size_t idx = 0; idx < values.size(); ++idx)
      result.push_back(sma(idx));
    return result;
  }

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  // all_ema
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  std::vector<double> all_ema() const
  {
    std::vector<double> result;
    for (size_t idx = 0; idx < values.size(); ++idx)
      result.push_back(ema(idx));
    return result;
  }

private:
  size_t period;
  std::vector<double> values;
};

#endif // METRICS_HH
